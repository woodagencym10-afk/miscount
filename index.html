<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор доставки</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow p-6; }
    .btn { @apply px-4 py-2 rounded-xl font-semibold transition border hover:shadow; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-xl mx-auto p-6">
    <h1 class="text-2xl md:text-3xl font-bold mb-4">Калькулятор вартості доставки</h1>

    <section class="card space-y-4">
      <div>
        <label class="text-sm text-gray-600">Відправна точка</label>
        <input class="w-full mt-1 rounded-xl border px-3 py-2 bg-gray-100 cursor-not-allowed" value="Львів" disabled />
      </div>
      <div>
        <label class="text-sm text-gray-600">Населений пункт</label>
        <input id="destination" class="w-full mt-1 rounded-xl border px-3 py-2" placeholder="Вкажіть місто" />
      </div>
      <div>
        <label class="text-sm text-gray-600">Область</label>
        <input id="regionInput" class="w-full mt-1 rounded-xl border px-3 py-2" placeholder="Вкажіть область" />
      </div>
      <div>
        <label class="text-sm text-gray-600">Вага (кг)</label>
        <input id="weightKg" type="number" min="1" step="1" class="w-full mt-1 rounded-xl border px-3 py-2" placeholder="Напр. 1200" />
      </div>
      <div>
        <label class="text-sm text-gray-600">Метраж (довжина вантажу, м)</label>
        <input id="lengthM" type="number" min="1" step="0.1" class="w-full mt-1 rounded-xl border px-3 py-2" placeholder="3–6" />
      </div>
      <div>
        <label class="text-sm text-gray-600">Тип дороги</label>
        <select id="roadType" class="w-full mt-1 rounded-xl border px-3 py-2">
          <option value="asphalt">Асфальт</option>
          <option value="rocky">Кам'яниста</option>
          <option value="dirt">Ґрунтова</option>
        </select>
      </div>

      <div class="flex gap-3 pt-2">
        <button id="btnCalc" class="btn bg-gray-900 text-white border-gray-900">Розрахувати</button>
        <button id="btnReset" class="btn border-gray-300">Скинути</button>
      </div>

      <p id="capacityNote" class="mt-1 text-sm hidden"></p>
      <div id="errBox" class="mt-2 hidden text-sm p-3 rounded-xl bg-red-50 text-red-700 border border-red-300"></div>
      <div id="offRouteBox" class="mt-2 hidden text-sm p-3 rounded-xl bg-yellow-50 text-yellow-700 border border-yellow-300"></div>
    </section>

    <aside class="card mt-6 bg-green-100">
      <div class="text-sm text-gray-700">Сума до оплати</div>
      <div id="totalPrice" class="text-3xl font-extrabold">—</div>
    </aside>
  </div>

  <input type="hidden" id="distanceKm" />

  <script>
    const U = { num: (v,d=0)=>isFinite(+v)?+ (+v).toFixed(d):0, fmt: (n)=>new Intl.NumberFormat('uk-UA').format(Math.round(n)) };
    let mapsReady = false;
    function initMaps(){ mapsReady = true; }
    window.initMaps = initMaps;

    const TRUCK = { maxWeightKg: 2500, cargoLenM: 4.2 };
    // Нормалізований список дозволених областей (без слова "область/обл.")
    const ROUTE_REGIONS = ['львівська','волинська','рівненська','тернопільська'];
    function normalizeRegion(s){
      if(!s) return '';
      let r = String(s).toLowerCase();
      r = r.replace('область','').replace('обл.','').replace('обл','');
      r = r.split(' ').join('').trim();
      return r;
    }
    function isRouteRegionInput(input){
      return ROUTE_REGIONS.includes(normalizeRegion(input));
    }

    function roadCoefFromSelect(val){
      if (val === 'dirt') return 800;
      if (val === 'rocky') return 400;
      return 0;
    }

    function lengthCoef(m){
      if (!isFinite(m)) return 0;
      if (m >= 6) return 700;
      if (m >= 5) return 400;
      return 0;
    }

    function weightCoef(kg){
      if (!isFinite(kg)) return 0;
      if (kg > 2000) return 1000;
      if (kg > 1500) return 700;
      if (kg > 1000) return 400;
      return 0;
    }

    function showErr(msg){ const b=document.getElementById('errBox'); b.textContent=msg; b.classList.remove('hidden'); }
    function hideErr(){ const b=document.getElementById('errBox'); b.classList.add('hidden'); b.textContent=''; }
    function showOffRoute(msg){ const b=document.getElementById('offRouteBox'); b.textContent=msg; b.classList.remove('hidden'); }
    function hideOffRoute(){ const b=document.getElementById('offRouteBox'); b.classList.add('hidden'); b.textContent=''; }

    function compute(){
      const weightKg = U.num(document.getElementById('weightKg').value,0);
      const lengthM = U.num(document.getElementById('lengthM').value,2);
      const roadType = document.getElementById('roadType').value;
      const km = U.num(document.getElementById('distanceKm').value,1);

      const baseFare = km*12;
      let total = Math.round(baseFare + lengthCoef(lengthM) + weightCoef(weightKg) + roadCoefFromSelect(roadType));
      // Кастомне заокруглення до сотень (1350 і більше → 1400, інакше → 1300)
      if(total % 100 !== 0){
        const hundreds = Math.floor(total/100)*100;
        total = (total - hundreds >= 50) ? hundreds+100 : hundreds;
      }
      document.getElementById('totalPrice').textContent = U.fmt(total)+" грн";

      const cap = document.getElementById('capacityNote');
      let warn=[];
      if(weightKg>TRUCK.maxWeightKg) warn.push('Вага > 2.5 т — інший транспорт.');
      if(lengthM>6) warn.push('Довжина >6 м — інший транспорт.');
      if(warn.length){ cap.classList.remove('hidden'); cap.textContent='⚠ '+warn.join(' ');} else { cap.classList.add('hidden'); cap.textContent=''; }
    }

    function fetchDistanceKm(callback){
      const city=document.getElementById('destination').value||'';
      const regionInput=document.getElementById('regionInput').value||'';
      if(!city){ showErr('Введіть населений пункт.'); return; }
      if(!regionInput){ showErr('Введіть область.'); return; }
      if(!mapsReady||!window.google||!google.maps){ showErr('Google Maps API не завантажено. Перевірте ключ, білінг та обмеження.'); return; }

      if(!isRouteRegionInput(regionInput)){
        showOffRoute('Доставка не по маршруту — уточніть вартість попутного транспорту, або ж скористайтесь прорахунком Delivery');
        document.getElementById('totalPrice').textContent = '—';
        return;
      } else { hideOffRoute(); }

      function regionForGeo(r){
        const v = String(r||'').toLowerCase();
        const hasWord = v.includes('область') || v.includes('обл');
        return hasWord ? r : (r + ' область');
      }
      const fullAddress = `${city}, ${regionForGeo(regionInput)}, Україна`;
      const service=new google.maps.DistanceMatrixService();
      service.getDistanceMatrix({
        origins:['Львів'],
        destinations:[fullAddress],
        travelMode:google.maps.TravelMode.DRIVING,
        unitSystem:google.maps.UnitSystem.METRIC
      },(resp,status)=>{
        if(status!=='OK'||!resp?.rows?.length){ showErr('Не вдалося отримати дистанцію (STATUS: '+status+').'); return; }
        const el=resp.rows[0]?.elements?.[0];
        if(el?.status==='OK'){
          const km=el.distance.value/1000;
          document.getElementById('distanceKm').value=U.num(km,1);
          hideErr(); if(callback) callback();
        } else {
          showErr('Маршрут не знайдено (ELEMENT: '+(el?.status||'UNKNOWN')+').');
        }
      });
    }

    document.getElementById('btnCalc').addEventListener('click',e=>{ e.preventDefault(); fetchDistanceKm(compute); });
    document.getElementById('btnReset').addEventListener('click',e=>{
      e.preventDefault();
      ['destination','regionInput','weightKg','lengthM'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('roadType').value='asphalt';
      document.getElementById('capacityNote').classList.add('hidden');
      document.getElementById('capacityNote').textContent='';
      document.getElementById('totalPrice').textContent='—';
      hideErr(); hideOffRoute();
    });
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFR9n0yr9SEPDWGyH1G_dDJBit7bxvy_Y&libraries=places&callback=initMaps" async defer></script>
</body>
</html>
