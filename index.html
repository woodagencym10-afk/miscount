<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-xl mx-auto p-6">
    <h1 class="text-2xl md:text-3xl font-bold mb-4">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤–∞—Ä—Ç–æ—Å—Ç—ñ –¥–æ—Å—Ç–∞–≤–∫–∏</h1>

    <section class="bg-white rounded-2xl shadow p-6 space-y-4">
      <div>
        <label class="text-sm text-gray-600">–í—ñ–¥–ø—Ä–∞–≤–Ω–∞ —Ç–æ—á–∫–∞</label>
        <input
          class="w-full mt-1 rounded-xl border px-3 py-2 bg-gray-100 cursor-not-allowed"
          value="–õ—å–≤—ñ–≤"
          disabled
        />
      </div>

      <div>
        <label class="text-sm text-gray-600">–ù–∞—Å–µ–ª–µ–Ω–∏–π –ø—É–Ω–∫—Ç</label>
        <input
          id="destination"
          class="w-full mt-1 rounded-xl border px-3 py-2"
          placeholder="–í–∫–∞–∂—ñ—Ç—å –º—ñ—Å—Ç–æ"
        />
      </div>

      <div>
        <label class="text-sm text-gray-600">–û–±–ª–∞—Å—Ç—å</label>
        <input
          id="regionInput"
          class="w-full mt-1 rounded-xl border px-3 py-2"
          placeholder="–í–∫–∞–∂—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –õ—å–≤—ñ–≤—Å—å–∫–∞)"
        />
      </div>

      <div>
        <label class="text-sm text-gray-600">–í–∞–≥–∞ (–∫–≥)</label>
        <input
          id="weightKg"
          type="number"
          min="1"
          step="1"
          class="w-full mt-1 rounded-xl border px-3 py-2"
          placeholder="–ù–∞–ø—Ä. 1200"
        />
      </div>

      <div>
        <label class="text-sm text-gray-600">–ú–µ—Ç—Ä–∞–∂ (–¥–æ–≤–∂–∏–Ω–∞ –≤–∞–Ω—Ç–∞–∂—É, –º)</label>
        <input
          id="lengthM"
          type="number"
          min="1"
          step="0.1"
          class="w-full mt-1 rounded-xl border px-3 py-2"
          placeholder="3‚Äì6"
        />
      </div>

      <div>
        <label class="text-sm text-gray-600">–¢–∏–ø –¥–æ—Ä–æ–≥–∏</label>
        <select
          id="roadType"
          class="w-full mt-1 rounded-xl border px-3 py-2"
        >
          <option value="asphalt">–ê—Å—Ñ–∞–ª—å—Ç</option>
          <option value="rocky">–ö–∞–º'—è–Ω–∏—Å—Ç–∞</option>
          <option value="dirt">“ê—Ä—É–Ω—Ç–æ–≤–∞</option>
        </select>
      </div>

      <div class="flex gap-3 pt-2">
        <button
          type="button"
          id="btnCalc"
          class="px-4 py-2 rounded-xl font-semibold transition border hover:shadow bg-gray-900 text-white border-gray-900"
        >
          –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏
        </button>
        <button
          type="button"
          id="btnReset"
          class="px-4 py-2 rounded-xl font-semibold transition border hover:shadow border-gray-300 bg-white"
        >
          –°–∫–∏–Ω—É—Ç–∏
        </button>
      </div>

      <p id="capacityNote" class="mt-1 text-sm hidden"></p>
      <div
        id="errBox"
        class="mt-2 hidden text-sm p-3 rounded-xl bg-red-50 text-red-700 border border-red-300"
      ></div>
      <div
        id="offRouteBox"
        class="mt-2 hidden text-sm p-3 rounded-xl bg-yellow-50 text-yellow-700 border border-yellow-300"
      ></div>
    </section>

    <aside class="bg-green-100 rounded-2xl shadow p-6 mt-6">
      <div class="text-sm text-gray-700">–°—É–º–∞ –¥–æ –æ–ø–ª–∞—Ç–∏</div>
      <div id="totalPrice" class="text-3xl font-extrabold">‚Äî</div>
    </aside>
  </div>

  <input type="hidden" id="distanceKm" />

  <script>
    // –£—Ç–∏–ª—ñ—Ç–∏
    const U = {
      num: (v, d = 0) => (isFinite(+v) ? +(+v).toFixed(d) : 0),
      fmt: (n) => new Intl.NumberFormat("uk-UA").format(Math.round(n)),
    };

    let mapsReady = false;
    function initMaps() {
      mapsReady = true;
    }
    window.initMaps = initMaps;

    const TRUCK = { maxWeightKg: 2500, cargoLenM: 4.2 };

    const ROUTE_REGIONS = [
      "–ª—å–≤—ñ–≤—Å—å–∫–∞",
      "–≤–æ–ª–∏–Ω—Å—å–∫–∞",
      "—Ä—ñ–≤–Ω–µ–Ω—Å—å–∫–∞",
      "—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞",
      "–∑–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞",
    ];

    const MAX_DEVIATION_KM = 100;

    function regionHub(normRegion) {
      switch (normRegion) {
        case "—Ä—ñ–≤–Ω–µ–Ω—Å—å–∫–∞":   return "–†—ñ–≤–Ω–µ, –£–∫—Ä–∞—ó–Ω–∞";
        case "–≤–æ–ª–∏–Ω—Å—å–∫–∞":    return "–õ—É—Ü—å–∫, –£–∫—Ä–∞—ó–Ω–∞";
        case "—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞":return "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å, –£–∫—Ä–∞—ó–Ω–∞";
        case "–∑–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞": return "–£–∂–≥–æ—Ä–æ–¥, –£–∫—Ä–∞—ó–Ω–∞";
        case "–ª—å–≤—ñ–≤—Å—å–∫–∞":
        default:             return "–õ—å–≤—ñ–≤, –£–∫—Ä–∞—ó–Ω–∞";
      }
    }

    function normalizeRegion(s) {
      if (!s) return "";
      let r = String(s).toLowerCase();
      r = r.replace("–æ–±–ª–∞—Å—Ç—å", "").replace("–æ–±–ª.", "").replace("–æ–±–ª", "");
      r = r.split(" ").join("").trim();
      return r;
    }

    function isRouteRegionInput(input) {
      return ROUTE_REGIONS.includes(normalizeRegion(input));
    }

    function roadCoefFromSelect(val) {
      if (val === "dirt") return 800;
      if (val === "rocky") return 400;
      return 0;
    }

    function lengthCoef(m) {
      if (!isFinite(m)) return 0;
      if (m >= 6) return 1000;
      if (m >= 5) return 600;
      return 0;
    }

    // –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –≤–∞–≥–∏ ‚Äî –¥–ª—è –≤—Å—ñ—Ö –æ–±–ª–∞—Å—Ç–µ–π
    function weightCoef(kg) {
      if (!isFinite(kg) || kg <= 0) return 0;

      if (kg > 2000)  return 2000; // –ø–æ–Ω–∞–¥ 2000 –∫–≥
      if (kg >= 1001) return 1000; // 1001‚Äì2000
      if (kg >= 800)  return 800;  // 800‚Äì1000
      if (kg >= 500)  return 500;  // 500‚Äì799

      return 0;                    // –¥–æ 499 –∫–≥
    }

    function showErr(msg) {
      const b = document.getElementById("errBox");
      b.textContent = msg;
      b.classList.remove("hidden");
    }

    function hideErr() {
      const b = document.getElementById("errBox");
      b.classList.add("hidden");
      b.textContent = "";
    }

    function showOffRoute(msg) {
      const b = document.getElementById("offRouteBox");
      b.textContent = msg;
      b.classList.remove("hidden");
    }

    function hideOffRoute() {
      const b = document.getElementById("offRouteBox");
      b.classList.add("hidden");
      b.textContent = "";
    }

    // –ì–û–õ–û–í–ù–ò–ô –†–û–ó–†–ê–•–£–ù–û–ö
    function compute() {
      const cityRaw   = document.getElementById("destination").value || "";
      const cityNorm  = cityRaw.trim().toLowerCase();
      const weightKg  = U.num(document.getElementById("weightKg").value, 0);
      const lengthM   = U.num(document.getElementById("lengthM").value, 2);
      const roadType  = document.getElementById("roadType").value;
      const km        = U.num(document.getElementById("distanceKm").value, 1);
      const regionRaw = document.getElementById("regionInput").value || "";
      const regionNorm = normalizeRegion(regionRaw);

      // 1. –¢–∞—Ä–∏—Ñ –ø–æ –∫—ñ–ª–æ–º–µ—Ç—Ä–∞–∂—É
      let perKm;
      if (regionNorm === "–ª—å–≤—ñ–≤—Å—å–∫–∞") {
        perKm = 12;
      } else {
        perKm = 14;
      }

      const kmFare = km * perKm;

      // 2. –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏
      const lenFee   = lengthCoef(lengthM);
      const roadFee  = roadCoefFromSelect(roadType);
      const weightFee= weightCoef(weightKg);

      // 3. –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ –Ω–∞—Ü—ñ–Ω–∫–∞
      let extra = kmFare + lenFee + roadFee + weightFee + 400;

      // 4. –ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å +1500
      if (regionNorm === "–∑–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞") {
        extra += 1500;
      }

      // 5. –ë–∞–∑–æ–≤–∞ —Å—É–º–∞ –ø–æ —Ä–µ–≥—ñ–æ–Ω—É
      let base = 0;
      let minTotal = 0;
      let maxTotal = Infinity;

      if (regionNorm === "–ª—å–≤—ñ–≤—Å—å–∫–∞") {
        base = 2000; // –±–∞–∑–∞ –ø–æ –õ—å–≤—ñ–≤—Å—å–∫—ñ–π
        if (cityNorm === "–±—Ä—é—Ö–æ–≤–∏—á—ñ") {
          base = 2500; // —Å–ø–µ—Ü–º—ñ–Ω—ñ–º–∞–ª–∫–∞ –¥–ª—è –ë—Ä—é—Ö–æ–≤–∏—á—ñ–≤
        }
      }

      // –î–ª—è –†—ñ–≤–Ω–µ–Ω—Å—å–∫–æ—ó/–í–æ–ª–∏–Ω—Å—å–∫–æ—ó/–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–æ—ó ‚Äì –¥—ñ–∞–ø–∞–∑–æ–Ω 2000‚Äì5000
      if (
        regionNorm === "—Ä—ñ–≤–Ω–µ–Ω—Å—å–∫–∞" ||
        regionNorm === "–≤–æ–ª–∏–Ω—Å—å–∫–∞" ||
        regionNorm === "—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞"
      ) {
        minTotal = 2000;
        maxTotal = 5000;
      }

      // 6. –°–∫–ª–∞–¥–∞—î–º–æ –≤—Å–µ
      let total = base + extra;

      // 7. –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –º—ñ–Ω/–º–∞–∫—Å (–¥–ª—è —Ç–∏—Ö, –∫–æ–≥–æ —Ü–µ —Å—Ç–æ—Å—É—î—Ç—å—Å—è)
      if (minTotal && total < minTotal) total = minTotal;
      if (isFinite(maxTotal) && total > maxTotal) total = maxTotal;

      // 8. –û–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ —Å–æ—Ç–µ–Ω—å
      total = Math.round(total);
      if (total % 100 !== 0) {
        const hundreds = Math.floor(total / 100) * 100;
        total = total - hundreds >= 50 ? hundreds + 100 : hundreds;
      }

      document.getElementById("totalPrice").textContent =
        U.fmt(total) + " –≥—Ä–Ω";

      // 9. –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø–æ –≤–∞–∑—ñ/–¥–æ–≤–∂–∏–Ω—ñ
      const cap = document.getElementById("capacityNote");
      let warn = [];
      if (weightKg > TRUCK.maxWeightKg)
        warn.push("–í–∞–≥–∞ > 2.5 —Ç ‚Äî —ñ–Ω—à–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç.");
      if (lengthM > 6) warn.push("–î–æ–≤–∂–∏–Ω–∞ > 6 –º ‚Äî —ñ–Ω—à–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç.");

      if (warn.length) {
        cap.classList.remove("hidden");
        cap.textContent = "‚ö† " + warn.join(" ");
      } else {
        cap.classList.add("hidden");
        cap.textContent = "";
      }
    }

    function fetchDistanceKm(callback) {
      const city        = document.getElementById("destination").value || "";
      const regionInput = document.getElementById("regionInput").value || "";

      if (!city) {
        showErr("–í–≤–µ–¥—ñ—Ç—å –Ω–∞—Å–µ–ª–µ–Ω–∏–π –ø—É–Ω–∫—Ç.");
        return;
      }
      if (!regionInput) {
        showErr("–í–≤–µ–¥—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å.");
        return;
      }

      if (!mapsReady || !window.google || !google.maps) {
        showErr("Google Maps API –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–ª—é—á, –±—ñ–ª—ñ–Ω–≥ —Ç–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è.");
        return;
      }

      if (!isRouteRegionInput(regionInput)) {
        const msg =
          "–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–µ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É ‚Äî —É—Ç–æ—á–Ω—ñ—Ç—å –≤–∞—Ä—Ç—ñ—Å—Ç—å –ø–æ–ø—É—Ç–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É, –∞–±–æ –∂ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å –ø—Ä–æ—Ä–∞—Ö—É–Ω–∫–æ–º Delivery";
        showOffRoute(msg);
        document.getElementById("totalPrice").textContent = "‚Äî";
        return;
      } else {
        hideOffRoute();
      }

      function regionForGeo(r) {
        const v = String(r || "").toLowerCase();
        const hasWord = v.includes("–æ–±–ª–∞—Å—Ç—å") || v.includes("–æ–±–ª");
        return hasWord ? r : r + " –æ–±–ª–∞—Å—Ç—å";
      }

      const fullAddress = `${city}, ${regionForGeo(regionInput)}, –£–∫—Ä–∞—ó–Ω–∞`;
      const hub = regionHub(normalizeRegion(regionInput));

      const svc = new google.maps.DistanceMatrixService();
      const OFF_ROUTE_MSG =
        "–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–µ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É ‚Äî —É—Ç–æ—á–Ω—ñ—Ç—å –≤–∞—Ä—Ç—ñ—Å—Ç—å –ø–æ–ø—É—Ç–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É, –∞–±–æ –∂ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å –ø—Ä–æ—Ä–∞—Ö—É–Ω–∫–æ–º Delivery";

      function dm(origins, destinations) {
        return new Promise((resolve, reject) => {
          svc.getDistanceMatrix(
            {
              origins,
              destinations,
              travelMode: google.maps.TravelMode.DRIVING,
              unitSystem: google.maps.UnitSystem.METRIC,
            },
            (res, st) => {
              if (st !== "OK" || !res?.rows?.length) {
                return reject(new Error("STATUS: " + st));
              }
              const el = res.rows[0]?.elements?.[0];
              if (!el || el.status !== "OK") {
                return reject(
                  new Error("ELEMENT: " + (el?.status || "UNKNOWN"))
                );
              }
              resolve(el.distance.value / 1000);
            }
          );
        });
      }

      dm([hub], [fullAddress])
        .then((devKm) => {
          if (devKm > MAX_DEVIATION_KM) {
            showOffRoute(
              `${OFF_ROUTE_MSG} (–≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è ${Math.round(
                devKm
              )} –∫–º > ${MAX_DEVIATION_KM} –∫–º)`
            );
            document.getElementById("totalPrice").textContent = "‚Äî";
            throw new Error("OFF_ROUTE");
          }
          hideOffRoute();
          return dm(["–õ—å–≤—ñ–≤, –£–∫—Ä–∞—ó–Ω–∞"], [fullAddress]);
        })
        .then((km) => {
          document.getElementById("distanceKm").value = U.num(km, 1);
          hideErr();
          if (callback) callback();
        })
        .catch((err) => {
          if (err.message !== "OFF_ROUTE") {
            showErr("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—é: " + err.message);
          }
        });
    }

    document
      .getElementById("btnCalc")
      .addEventListener("click", () => fetchDistanceKm(compute));

    document.getElementById("btnReset").addEventListener("click", () => {
      ["destination", "regionInput", "weightKg", "lengthM"].forEach(
        (id) => (document.getElementById(id).value = "")
      );
      document.getElementById("roadType").value = "asphalt";
      document.getElementById("capacityNote").classList.add("hidden");
      document.getElementById("capacityNote").textContent = "";
      document.getElementById("totalPrice").textContent = "‚Äî";
      hideErr();
      hideOffRoute();
    });
  </script>

  <!-- üîë –°—é–¥–∏ –≤—Å—Ç–∞–≤ —Å–≤—ñ–π Google Maps API KEY -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFR9n0yr9SEPDWGyH1G_dDJBit7bxvy_Y&libraries=places&callback=initMaps" async defer></script>
</body>
</html>
