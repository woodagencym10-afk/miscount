<script>
  const U = {
    num: (v, d = 0) => isFinite(+v) ? +(+v).toFixed(d) : 0,
    fmt: (n) => new Intl.NumberFormat('uk-UA').format(Math.round(n))
  };
  let mapsReady = false;
  function initMaps() { mapsReady = true; }
  window.initMaps = initMaps;

  const TRUCK = { maxWeightKg: 2500, cargoLenM: 4.2 };
  // –î–û–î–ê–í –ó–ê–ö–ê–†–ü–ê–¢–°–¨–ö–£
  const ROUTE_REGIONS = ['–ª—å–≤—ñ–≤—Å—å–∫–∞', '–≤–æ–ª–∏–Ω—Å—å–∫–∞', '—Ä—ñ–≤–Ω–µ–Ω—Å—å–∫–∞', '—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞', '–∑–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞'];
  const MAX_DEVIATION_KM = 100;

  function regionHub(normRegion) {
    switch (normRegion) {
      case '—Ä—ñ–≤–Ω–µ–Ω—Å—å–∫–∞': return '–†—ñ–≤–Ω–µ, –£–∫—Ä–∞—ó–Ω–∞';
      case '–≤–æ–ª–∏–Ω—Å—å–∫–∞': return '–õ—É—Ü—å–∫, –£–∫—Ä–∞—ó–Ω–∞';
      case '—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞': return '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å, –£–∫—Ä–∞—ó–Ω–∞';
      case '–ª—å–≤—ñ–≤—Å—å–∫–∞': return '–õ—å–≤—ñ–≤, –£–∫—Ä–∞—ó–Ω–∞';
      case '–∑–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞': return '–£–∂–≥–æ—Ä–æ–¥, –£–∫—Ä–∞—ó–Ω–∞'; // üîπ –Ω–æ–≤–∏–π —Ö–∞–±
      default: return '–õ—å–≤—ñ–≤, –£–∫—Ä–∞—ó–Ω–∞';
    }
  }

  function normalizeRegion(s) {
    if (!s) return '';
    let r = String(s).toLowerCase();
    r = r.replace('–æ–±–ª–∞—Å—Ç—å', '').replace('–æ–±–ª.', '').replace('–æ–±–ª', '');
    r = r.split(' ').join('').trim();
    return r;
  }

  function isRouteRegionInput(input) { return ROUTE_REGIONS.includes(normalizeRegion(input)); }

  function roadCoefFromSelect(val) { if (val === 'dirt') return 800; if (val === 'rocky') return 400; return 0; }
  function lengthCoef(m) {
    if (!isFinite(m)) return 0;
    if (m >= 6) return 1000;
    if (m >= 5) return 600;
    return 0;
  }
  function weightCoef(kg) {
    if (!isFinite(kg)) return 0;
    if (kg > 2000) return 2000;
    if (kg > 1500) return 1000;
    return 0;
  }

  function showErr(msg) {
    const b = document.getElementById('errBox');
    b.textContent = msg;
    b.classList.remove('hidden');
  }
  function hideErr() {
    const b = document.getElementById('errBox');
    b.classList.add('hidden');
    b.textContent = '';
  }
  function showOffRoute(msg) {
    const b = document.getElementById('offRouteBox');
    b.textContent = msg;
    b.classList.remove('hidden');
  }
  function hideOffRoute() {
    const b = document.getElementById('offRouteBox');
    b.classList.add('hidden');
    b.textContent = '';
  }

  function compute() {
    const city = (document.getElementById('destination').value || '').trim();
    const weightKg = U.num(document.getElementById('weightKg').value, 0);
    const lengthM = U.num(document.getElementById('lengthM').value, 2);
    const roadType = document.getElementById('roadType').value;
    const km = U.num(document.getElementById('distanceKm').value, 1);
    const regionInput = document.getElementById('regionInput').value || '';

    const regionNorm = normalizeRegion(regionInput);
    const cityNorm = city.toLowerCase();

    // === –ë–ê–ó–û–í–ò–ô –¢–ê–†–ò–§ –ü–û –†–ï–ì–Ü–û–ù–ê–• ===
    let baseFare;
    if (regionNorm === '–ª—å–≤—ñ–≤—Å—å–∫–∞') {
      // –õ—å–≤—ñ–≤—Å—å–∫–∞: –±–∞–∑–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ —è–∫ –±—É–ª–∞
      baseFare = 1000 + km * 12;
    } else {
      // –Ü–Ω—à—ñ –æ–±–ª–∞—Å—Ç—ñ (–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞, –í–æ–ª–∏–Ω—Å—å–∫–∞, –¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞, –ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ ...)
      baseFare = km * 14;
    }

    // –ó–∞–∫–∞—Ä–ø–∞—Ç—Ç—è: +1500 –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ—ó —Å—É–º–∏
    if (regionNorm === '–∑–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞') {
      baseFare += 1500;
    }

    // –î–æ–¥–∞—î–º–æ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏
    let total = baseFare
      + lengthCoef(lengthM)
      + weightCoef(weightKg)
      + roadCoefFromSelect(roadType);

    // === –ú–Ü–ù–Ü–ú–ê–õ–¨–ù–Ü / –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–Ü –°–£–ú–ò ===
    let minTotal = 0;
    let maxTotal = Infinity;

    // –õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å: –º—ñ–Ω—ñ–º—É–º 2000
    if (regionNorm === '–ª—å–≤—ñ–≤—Å—å–∫–∞') {
      minTotal = 2000;

      // –ë—Ä—é—Ö–æ–≤–∏—á—ñ —è–∫ —Å–ø–µ—Ü–≤–∏–ø–∞–¥–æ–∫: –º—ñ–Ω—ñ–º—É–º 2500
      if (cityNorm === '–±—Ä—é—Ö–æ–≤–∏—á—ñ') {
        minTotal = 2500;
      }
    }

    // –†—ñ–≤–Ω–µ / –õ—É—Ü—å–∫ / –¢–µ—Ä–Ω–æ–ø—ñ–ª—å (–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –æ–±–ª–∞—Å—Ç—ñ):
    // —Ü—ñ–Ω–∞ –≤ –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ 2000‚Äì5000
    if (
      regionNorm === '—Ä—ñ–≤–Ω–µ–Ω—Å—å–∫–∞' ||
      regionNorm === '–≤–æ–ª–∏–Ω—Å—å–∫–∞' ||
      regionNorm === '—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞'
    ) {
      minTotal = 2000;
      maxTotal = 5000;
    }

    // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –º—ñ–Ω/–º–∞–∫—Å –¥–æ —Å—É–º–∏
    if (minTotal && total < minTotal) total = minTotal;
    if (isFinite(maxTotal) && total > maxTotal) total = maxTotal;

    // –û–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ —Å–æ—Ç–µ–Ω—å
    total = Math.round(total);
    if (total % 100 !== 0) {
      const hundreds = Math.floor(total / 100) * 100;
      total = (total - hundreds >= 50) ? hundreds + 100 : hundreds;
    }

    document.getElementById('totalPrice').textContent = U.fmt(total) + " –≥—Ä–Ω";

    // –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø–æ –≤–∞–∑—ñ/–¥–æ–≤–∂–∏–Ω—ñ
    const cap = document.getElementById('capacityNote');
    let warn = [];
    if (weightKg > TRUCK.maxWeightKg) warn.push('–í–∞–≥–∞ > 2.5 —Ç ‚Äî —ñ–Ω—à–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç.');
    if (lengthM > 6) warn.push('–î–æ–≤–∂–∏–Ω–∞ >6 –º ‚Äî —ñ–Ω—à–∏–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç.');
    if (warn.length) {
      cap.classList.remove('hidden');
      cap.textContent = '‚ö† ' + warn.join(' ');
    } else {
      cap.classList.add('hidden');
      cap.textContent = '';
    }
  }

  function fetchDistanceKm(callback) {
    const city = document.getElementById('destination').value || '';
    const regionInput = document.getElementById('regionInput').value || '';
    if (!city) { showErr('–í–≤–µ–¥—ñ—Ç—å –Ω–∞—Å–µ–ª–µ–Ω–∏–π –ø—É–Ω–∫—Ç.'); return; }
    if (!regionInput) { showErr('–í–≤–µ–¥—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å.'); return; }
    if (!mapsReady || !window.google || !google.maps) {
      showErr('Google Maps API –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–ª—é—á, –±—ñ–ª—ñ–Ω–≥ —Ç–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è.');
      return;
    }

    if (!isRouteRegionInput(regionInput)) {
      const msg = '–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–µ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É ‚Äî —É—Ç–æ—á–Ω—ñ—Ç—å –≤–∞—Ä—Ç—ñ—Å—Ç—å –ø–æ–ø—É—Ç–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É, –∞–±–æ –∂ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å –ø—Ä–æ—Ä–∞—Ö—É–Ω–∫–æ–º Delivery';
      showOffRoute(msg);
      document.getElementById('totalPrice').textContent = '‚Äî';
      return;
    } else {
      hideOffRoute();
    }

    function regionForGeo(r) {
      const v = String(r || '').toLowerCase();
      const hasWord = v.includes('–æ–±–ª–∞—Å—Ç—å') || v.includes('–æ–±–ª');
      return hasWord ? r : (r + ' –æ–±–ª–∞—Å—Ç—å');
    }
    const fullAddress = `${city}, ${regionForGeo(regionInput)}, –£–∫—Ä–∞—ó–Ω–∞`;
    const hub = regionHub(normalizeRegion(regionInput));

    const svc = new google.maps.DistanceMatrixService();
    const OFF_ROUTE_MSG =
      '–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–µ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É ‚Äî —É—Ç–æ—á–Ω—ñ—Ç—å –≤–∞—Ä—Ç—ñ—Å—Ç—å –ø–æ–ø—É—Ç–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É, –∞–±–æ –∂ —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—å –ø—Ä–æ—Ä–∞—Ö—É–Ω–∫–æ–º Delivery';

    function dm(origins, destinations) {
      return new Promise((resolve, reject) => {
        svc.getDistanceMatrix({
          origins, destinations,
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC
        }, (res, st) => {
          if (st !== 'OK' || !res?.rows?.length) {
            return reject(new Error('STATUS: ' + st));
          }
          const el = res.rows[0]?.elements?.[0];
          if (!el || el.status !== 'OK') {
            return reject(new Error('ELEMENT: ' + (el?.status || 'UNKNOWN')));
          }
          resolve(el.distance.value / 1000);
        });
      });
    }

    dm([hub], [fullAddress])
      .then(devKm => {
        if (devKm > MAX_DEVIATION_KM) {
          showOffRoute(`${OFF_ROUTE_MSG} (–≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è ${Math.round(devKm)} –∫–º > ${MAX_DEVIATION_KM} –∫–º)`);
          document.getElementById('totalPrice').textContent = '‚Äî';
          throw new Error('OFF_ROUTE');
        }
        hideOffRoute();
        return dm(['–õ—å–≤—ñ–≤, –£–∫—Ä–∞—ó–Ω–∞'], [fullAddress]);
      })
      .then(km => {
        document.getElementById('distanceKm').value = U.num(km, 1);
        hideErr();
        if (callback) callback();
      })
      .catch(err => {
        if (err.message !== 'OFF_ROUTE') showErr('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—é: ' + err.message);
      });
  }

  document.getElementById('btnCalc').addEventListener('click', () => { fetchDistanceKm(compute); });
  document.getElementById('btnReset').addEventListener('click', () => {
    ['destination', 'regionInput', 'weightKg', 'lengthM'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('roadType').value = 'asphalt';
    document.getElementById('capacityNote').classList.add('hidden');
    document.getElementById('capacityNote').textContent = '';
    document.getElementById('totalPrice').textContent = '‚Äî';
    hideErr(); hideOffRoute();
  });
</script>
